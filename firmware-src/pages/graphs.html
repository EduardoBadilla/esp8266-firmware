<html>
<head>
	<link rel="stylesheet" type="text/css" href="style.css">
	<title>Graphs</title>
	<style>
text.label-text {
	fill: black;
}
path.line {
	fill: none;
	stroke: black;
	stroke-width: 1.6px;
}
.axis-x path.domain {
	stroke: rgba(0.8, 0.8, 0.8, 0.5);
}
.axis-y path.domain {
	stroke-width: 1.6px;
}
path.line-0, .axis-y-0 path.domain {
	stroke: #cc5658;
}
path.line-1, .axis-y-1 path.domain {
	stroke: #6885d0;
}
text.label-left {
	transform: rotate(-90deg) translate(0, 1.5em);
}
text.label-right {
	transform: rotate(90deg) translateY(1.5em);
}
.legend {
	margin-left: 40px;
}
.legend label {
	display: inline-block;
	margin-right: 20px;
}
.legend input[type="checkbox"] {
	vertical-align: middle;
}
	</style>
	<script src="libs.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.1/d3.min.js"></script>
	<script>
/*jshint browser: true*/
/*globals d3, ajax, getKey*/
var now = function() {
	return new Date().getTime();
};
var plot;
var initPlot = function() {
	var data = [];
	var maxTimeRange = 60 * 1000;
	var minTimeRange = 10 * 1000;
	var dirty = true;
	var cutOff = false;

	var margin = {top: 20, right: 40, bot: 30, left: 40};
	var svg = d3.select('svg');
	var width = +svg.attr('width') - margin.left - margin.right;
	var height = +svg.attr('height') - margin.top - margin.bot;
	var g = svg.append('g')
		.attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');

	var scaleX = d3.scaleTime().rangeRound([0, width]);
	var scaleY = d3.scaleLinear().rangeRound([height, 0]);

	var axisX;
	var axisY;
	var sources = [];
	var strkey = function(key) {
		if (!Array.isArray(key)) {
			return key;
		}
		return key.join('.');
	};
	var setSources = function(srcs) {
		sources = srcs.map(function(src, idx) {
			var key = strkey(src.key);
			var line = d3.line()
				.x(function(d) { return scaleX(d.ts); })
				.y(function(d) { return scaleY(d[key]); });

			return {
				idx: idx,
				left: !!src.left,
				akey: src.key,
				key: key,
				label: src.label,
				minDomain: src.minDomain,
				line: line
			};
		});

		g.select('path.line').remove();
		sources.forEach(function(src) {
			var lineClass = src.left ? 'line-left' : 'line-right';
			src.path = g.append('path')
				.attr('class', 'line ' + lineClass + ' line-' + src.idx);
		});

		var legend = sources.map(function(src) {
			return ['label', {}, ['input', {type: 'checkbox'}], src.label || src.key]
		});
		legend = ['span', {}].concat(legend);
		replaceDom(byId('legend'), legend);

		dirty = true;
	};

	var lookup = function(obj, key) {
		if (!Array.isArray(key)) {
			return obj[key];
		}
		key.forEach(function(k) {
			obj = obj[k];
		});
		return obj;
	};

	var deriveConfig = function (obj) {
		var measures = [];
		Object.keys(obj).forEach(function(k) {
			var v = obj[k];
			if (typeof v === 'object') {
				deriveConfig(v).forEach(function(m) {
					m.key = [k].concat(m.key);
					measures.push(m);
				});
			} else {
				measures.push({
					key: [k],
				});
			}
		});
		return measures;
	};

	var feed = function(datum) {
		var ts = now();
		if (sources.length === 0) {
			// hax
			setSources(deriveConfig(datum));
		};
		var d = {ts: ts};
		sources.forEach(function(s) {
			d[s.key] = lookup(datum, s.akey);
		});
		data.push(d);
		dirty = true;
	};

	var cutOld = function() {
		var ts = now();
		var cutTime = ts - maxTimeRange;
		var i;
		for (i = 0; i < data.length - 1; i++) {
			if (data[i].ts >= cutTime) {
				break;
			}
		}
		if (i > 1) {
			data = data.slice(i - 1);
			cutOff = true;
			dirty = true;
		}
	};

	var calcExtentX = function() {
		var ts = now();
		var left = d3.min(data, function(d) { return d.ts; });
		if (cutOff || typeof left === 'undefined') {
			left = ts - maxTimeRange;
		}
		left = Math.min(left, ts - minTimeRange);
		return [left, ts];
	};
	var calcExtentY = function() {
		var domain = [];
		sources.forEach(function(src) {
			domain = domain.concat(d3.extent(data, function(d) { return d[src.key]; }));
		});
		return d3.extent(domain);
	};

	var reset = function() {
		data = [];
		sources.forEach(function(src) {
			src.path.datum([]).attr('d', src.line);
		});
		sources = [];
		dirty = true;
		cutOff = false;
	};

	var redraw = function() {
		cutOld();
		scaleX.domain(calcExtentX());
		redrawAxisX();

		scaleY.domain(calcExtentY());
		redrawAxisY();
		sources.forEach(function(src) {
			src.path.datum(data).attr('d', src.line);
		});

		dirty = false;
	};

	var redrawAxisX = function() {
		if (axisX) {
			axisX.remove();
		}
		axisX = g.append('g')
			.attr("class", "axis-x")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(scaleX).tickArguments([undefined, '%H:%M:%S']));
	};

	var redrawAxisY = function(src) {
		if (axisY) {
			axisY.remove();
		}
		axisY = g.append('g')
			.attr("class", "axis-y")
				.call(d3.axisLeft(scaleY));
	};

	return {
		reset: reset,
		setSources: setSources,
		feed: feed,
		redraw: redraw
	};
};

var dataSource;
var initDataSource = function(opts) {
	var interval = Math.max(opts.interval || 1000, 200);

	var running = false;
	var requestInProgress = false;
	var sink;
	var loop = function() {
		if (requestInProgress || !running) {
			return;
		}
		requestInProgress = true;
		ajax(opts.verb, opts.url, opts.params, getKey(), function(xhr) {
			if (!running) {
				return;
			}
			requestInProgress = false;
			if (xhr.status < 200 || xhr.status > 299) {
				console.error('error getting data:', xhr);
				return;
			}
			var datum;
			try {
				datum = JSON.parse(xhr.responseText);
				if (typeof opts.map === 'function') {
					datum = opts.map(datum);
				}
			} catch(e) {
				console.error('error during data transformation:', e);
			}

			sink.feed(datum);
		});
	};

	var intervalId;
	var start = function(target) {
		if (running) {
			return;
		}
		sink = target;
		running = true;
		intervalId = setInterval(loop, interval);
	};
	var stop = function() {
		if (!running) {
			return;
		}
		running = false;
		sink = null;
		if (typeof intervalId !== 'undefined') {
			clearInterval(intervalId);
		}
	};

	return {
		start: start,
		stop: stop
	};
};

var renderLoop = (function() {
	var raf = window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback) {
				return window.setTimeout(callback, 16);
			};
	var caf = window.cancelAnimationFrame ||
		window.webkitCancelAnimationFrame ||
		window.mozCancelAnimationFrame ||
		window.oCancelAnimationFrame ||
		window.msCancelAnimationFrame ||
		function(id) {
			window.clearTimeout(id);
		};

	var running = false;
	var rafId;
	var loop = function() {
		if (!running) {
			return;
		}

		try {
			if (plot) {
				plot.redraw();
			}
		} catch(e) {
		/// ???
		}
		rafId = raf(loop);
	};

	var start = function() {
		if (running) {
			return;
		}
		running = true;
		loop();
	};

	var stop = function() {
		if (!running) {
			return;
		}
		running = false;
		caf(rafId);
	};

	var isRunning = function() {
		return running;
	};

	return {
		stop: stop,
		start: start,
		isRunning: isRunning
	};
})();

window.onload = function init() {
	plot = initPlot();
	plot.redraw();
};

var selectSource = function(name) {
	if (dataSource) {
		dataSource.stop();
		dataSource = null;
	}
	plot.reset();
	renderLoop.stop();
	if (name === '') {
		return;
	}
	dataSource = initDataSource({
		verb: 'GET',
		url: 'http://esp-office.vrn.dataart.net/api/devices/' + name + '/read',
		params: null,
	});
	//plot.setSources(cfg.plotConfig);
	dataSource.start(plot);
	renderLoop.start();
};
	</script>
</head>
<body>
<div class="header">
	<a href="./help.html"><div class="devecihive-logo-text"></div></a>
	<div class="key-box">
		<label for="accesskey">AccesKey: </label>
		<input class="input-accesskey input-data" type="password" id="accesskey">
	</div>
</div>
<div class="content">
	<div class="form-block">
		<div class="description">This sample page plots readouts over time.</div>
		<div class="group-box">
			<select onchange="selectSource(this.value)">
				<option value="">Select data source to plot</option>
				<option value="mpu6050">MPU6050 (temperature)</option>
			</select>
			<svg width="1000" height="480"></svg>
			<div id="legend" class="legend"></div>
		</div>
		<div class="output-status" id="output"></div>
	</div>
</div>
</body>
</html>
